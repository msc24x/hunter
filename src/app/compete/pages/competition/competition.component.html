<app-bar></app-bar>
<app-loading *ngIf="loading"></app-loading>

<div class="body">
    <div class="main">
        <app-info-card
            [persist]="true"
            *ngIf="!isAuthenticated"
            (click)="redirectToGitHubOAuth()"
        >
            <br />
            <div class="row">
                Want to test your skills, click here to Sign in using GitHub
            </div>
            <br />
        </app-info-card>

        <app-info-card *ngIf="hasEnded" [persist]="true">
            Oops! looks like you have missed the opportunity to participate in
            the competition. Meantime, you can practice other live competitions.
        </app-info-card>

        <popup
            [hidden]="!showInstructionP"
            (closeEvent)="showInstructionP = false"
            [showControls]="false"
            title="Important Instructions To Follow"
        >
            <ul>
                <li>
                    The available questions are displayed in the 'Questions'
                    list. Submission can be done only if one is selected.
                </li>
                <li>
                    Make sure that your are writing code in right selected
                    language.
                </li>
                <li>
                    To check the correctness of your code, use Run Test Cases
                    button to run your code against one sample test case. This
                    won't result in any penalty if some error occurred.
                </li>
                <li>
                    Make sure to submit appropriate time before the competition
                    ends, unless it is a live forever competition.
                </li>
                <li>
                    To Fetch Last Submission, you must have to make at least one
                    Submit or Run Test Cases. Be aware enough not to close the
                    tab and loose your in progress code.
                </li>
                <li>
                    Every wrong submission results in penalty and affects your
                    Rank.
                </li>
                <li>
                    Once you have made any successful submission, the points of
                    the question will be accumulated in your total score. No
                    penalty would be counted after this.
                </li>
                <li>
                    If the host had not uploaded the files for test cases or the
                    sample test cases, Output will return an error describing
                    the same. In this case you can wait for host to update the
                    competition or contact the Hunter team to report the
                    competition.
                </li>
                <li>
                    Hunter being truly open for everyone to host, we respect the
                    reliability for the participants. Kindly report any bad
                    competition to the Hunter immediately.
                </li>
            </ul>
        </popup>

        <div *ngIf="isAuthenticated" id="competition_info">
            <div class="title-duration-container">
                <b>
                    {{ this.competition.title }}
                    <infotip
                        message="Click to read instructions"
                        (click)="showInstructionP = true"
                        [svgSize]="'sm'"
                    ></infotip>
                </b>
                <div *ngIf="!hasEnded && isAuthenticated" id="duration_info">
                    <fa-icon [icon]="timerIcon"></fa-icon>
                    <span style="width: max-content">
                        &nbsp; &nbsp;
                        {{ timeRemaining }}
                    </span>
                </div>
            </div>

            <input type="checkbox" id="description-toggle" hidden />
            <p class="description-toggle-content">
                <label
                    class="description-toggle-content-a"
                    for="description-toggle"
                >
                    Read description
                </label>
                <label
                    class="description-toggle-content-b"
                    for="description-toggle"
                    matTooltip="Click to collapse"
                >
                    {{ this.competition.description }}
                </label>
            </p>
        </div>

        <div
            [ngClass]="{ 'row compete-hr-layout': hrlayout }"
            *ngIf="!hasEnded && isAuthenticated && questionSelected !== -1"
        >
            <!-- Questions -->
            <div class="question-section">
                <div class="row questions-container">
                    <questions-list
                        [competitionInfo]="competition"
                        [questionsList]="competition.questions || []"
                        [editable]="false"
                        (questionSelectEmitter)="selectQuestion($event)"
                        [(questionSelected)]="questionSelected"
                        [questionsProgress]="questionsProgress"
                    ></questions-list>

                    <label
                        for="toggle-layout"
                        class="hsection pointer toggle-layout-label"
                        matTooltip="Toggle the editor layout"
                        [ngClass]="{ 'active': hrlayout }"
                    >
                        <fa-icon [icon]="layoutIcon"></fa-icon>
                    </label>

                    <input
                        id="toggle-layout"
                        type="checkbox"
                        name="hrlayout"
                        hidden
                        (change)="toggleLayout()"
                    />
                </div>

                <div id="question_title">
                    Correct Submission:
                    <b>{{ questionSelectedInfo.points }} </b> points
                    <br />
                    <span *ngIf="!questionSelectedInfo.neg_points">
                        No negative marking
                    </span>
                    <span *ngIf="questionSelectedInfo.neg_points">
                        Each incorrect submission:
                        <b>-{{ questionSelectedInfo.neg_points }} </b> points
                    </span>

                    <br /><br />
                    {{ questionSelectedInfo.title }}
                </div>

                <div id="question_statement">
                    <ng-katex
                        [data]="getQuestionStatement(questionSelectedInfo)"
                    ></ng-katex>
                </div>
            </div>

            <!-- Code editor -->
            <code-editor
                class="ace-editor"
                [(code)]="codeWritten"
                [(languageSelected)]="languageSelected"
                (fetchLastSubmission)="fetchLastSubmission()"
            >
            </code-editor>
        </div>

        <!-- <app-info-card>Execution services are down at the moment, the remote code execution system is being re-organized and will be back once ready to ship.</app-info-card> -->
        <div
            id="submit_controls"
            *ngIf="!hasEnded && questionSelected != -1 && isAuthenticated"
            class="row"
        >
            <div
                class="button"
                id="submit_code_samples_btn"
                (click)="postSolution(true)"
                [matTooltipPosition]="'above'"
                [matTooltip]="'Test samples (Shift + Alt + J)'"
            >
                Test Sample Cases
            </div>
            <div
                matTooltip="Only submit when you're ready, to avoid negative marking"
                class="button"
                id="submit_code_btn"
                [matTooltipPosition]="'above'"
                (click)="postSolution()"
            >
                <fa-icon [icon]="submitIcon"></fa-icon>
                &nbsp; Submit & Evaluate
            </div>
        </div>
    </div>

    <br />

    <div class="bottom-section" [ngClass]="{ 'full': bottomSection }">
        <div
            class="section-toggle"
            (click)="bottomSection = !bottomSection"
            matTooltip="Toggle (Ctrl + `)"
        >
            <fa-icon [icon]="upIcon"></fa-icon>
        </div>

        <h2>Question Evaluation</h2>

        <div id="output_points">
            <question-evaluation [questionSelectedInfo]="questionSelectedInfo">
            </question-evaluation>

            <div id="solution_output">
                <div class="loading" *ngIf="judgeInProgress">
                    <fa-icon
                        [icon]="judgeLoadingIcon"
                        [spin]="true"
                        [pulse]="true"
                    ></fa-icon>
                    &nbsp;&nbsp; Judging... this may take a few seconds
                </div>
                <div *ngIf="solutionOutput.output">
                    <h3>Output<br /></h3>
                    <pre [innerText]="solutionOutput.output"></pre>
                </div>

                <div *ngIf="solutionOutput.expected">
                    <h3>Expected<br /></h3>
                    <pre [innerText]="solutionOutput.expected"></pre>
                </div>

                <pretty-meta
                    [meta]="solutionOutput.meta"
                    [success]="solutionOutput.success"
                ></pretty-meta>
            </div>
        </div>

        <br />
        <h2 *ngIf="competition.questions">Your Overall Progress</h2>

        <div *ngIf="competition.questions" class="progress-container">
            <div class="progress-box">
                <span class="progress-num">
                    {{ questionsProgress.length }} of
                    {{ competition.questions.length }}
                </span>
                Questions Attempted
                <greenred
                    [green_number]="questionsProgress.length"
                    [red_number]="
                        (competition.questions.length || 1) -
                        questionsProgress.length
                    "
                    green_label="Attempted"
                    red_label="Unattempted"
                ></greenred>
            </div>

            <div class="progress-box">
                <span class="progress-num">
                    {{ getAcceptedSolutions() }} of
                    {{ questionsProgress.length }}
                </span>
                Questions Accepted
                <greenred
                    [green_number]="getAcceptedSolutions()"
                    [red_number]="
                        questionsProgress.length - getAcceptedSolutions()
                    "
                    green_label="Accepted"
                    red_label="Not Accepted"
                ></greenred>
            </div>

            <div class="progress-box score-box">
                You aggregated a total of &nbsp;
                <span class="progress-num">
                    {{ getTotalScore() }}
                </span>
                points
            </div>
        </div>

        <scoreboard [competition_id]="c_id"></scoreboard>
    </div>
</div>
