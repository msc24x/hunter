<app-bar></app-bar>
<app-loading *ngIf="loading"></app-loading>

<popup
    id="view-submission-popup"
    [hidden]="!showSubmissionP"
    (closeEvent)="showSubmissionP = false; viewSubmissionResult = undefined"
    [showControls]="false"
    title="Your Submission"
>
    <div class="view-submission-container" *ngIf="viewSubmissionResult">
        <pretty-meta [meta]="viewSubmissionResult.meta!"></pretty-meta>

        <code-editor
            [editable]="false"
            [code]="viewSubmissionResult.submission!"
            [languageSelected]="viewSubmissionResult.language!"
        ></code-editor>
        <!-- <pre [innerText]="viewSubmissionResult.submission"></pre> -->
    </div>
</popup>

<div class="body">
    <div class="main">
        <app-info-card
            [persist]="true"
            *ngIf="!isAuthenticated"
            (click)="redirectToGitHubOAuth()"
        >
            <fa-icon [icon]="loginIcon" size="2x"></fa-icon>
            <h3>
                Want to test your skills? Do a quick sign in to participant!
            </h3>
            <br />
        </app-info-card>

        <app-info-card *ngIf="hasEnded" [persist]="true">
            Oops! looks like you have missed the opportunity to participate in
            the competition. Meantime, you can practice other live competitions.
        </app-info-card>

        <popup
            [hidden]="!showInstructionP"
            (closeEvent)="showInstructionP = false"
            [showControls]="false"
            title="Important Instructions To Follow"
        >
            <ul>
                <li>
                    The available questions are displayed in the 'Questions'
                    list. Submission can be done only if one is selected.
                </li>
                <li>
                    Make sure that your are writing code in right selected
                    language.
                </li>
                <li>
                    To check the correctness of your code, use Run Test Cases
                    button to run your code against one sample test case. This
                    won't result in any penalty if some error occurred.
                </li>
                <li>
                    Make sure to submit appropriate time before the competition
                    ends, unless it is a live forever competition.
                </li>
                <li>
                    To Fetch Last Submission, you must have to make at least one
                    Submit or Run Test Cases. Be aware enough not to close the
                    tab and loose your in progress code.
                </li>
                <li>
                    Every wrong submission results in penalty and affects your
                    Rank.
                </li>
                <li>
                    Once you have made any successful submission, the points of
                    the question will be accumulated in your total score. No
                    penalty would be counted after this.
                </li>
                <li>
                    If the host had not uploaded the files for test cases or the
                    sample test cases, Output will return an error describing
                    the same. In this case you can wait for host to update the
                    competition or contact the Hunter team to report the
                    competition.
                </li>
                <li>
                    Hunter being truly open for everyone to host, we respect the
                    reliability for the participants. Kindly report any bad
                    competition to the Hunter immediately.
                </li>
            </ul>
        </popup>

        <div *ngIf="isAuthenticated" id="competition_info">
            <div>
                <b>{{ this.competition.title }}</b>
                <infotip
                    message="Click to read instructions"
                    (click)="showInstructionP = true"
                    [svgSize]="'sm'"
                ></infotip>

                <p>
                    {{ this.competition.description }}
                </p>
            </div>

            <div *ngIf="!hasEnded && isAuthenticated" id="duration_info">
                <!-- <span class="label">Time left</span> -->
                <!-- <br /> -->
                <fa-icon [icon]="timerIcon"></fa-icon>
                <span style="width: max-content">
                    &nbsp; &nbsp;
                    {{ timeRemaining }}
                </span>
                <!-- <b>{{ timeRemaining.min || "&infin;" }}</b> mins
                <b>{{ timeRemaining.sec || "&infin;" }}</b> s -->
            </div>
        </div>

        <div
            [ngClass]="{ 'row compete-hr-layout': hrlayout }"
            *ngIf="!hasEnded && isAuthenticated && questionSelected !== -1"
        >
            <!-- Questions -->
            <div class="question-section">
                <div class="row questions-container">
                    <questions-list
                        [competitionInfo]="competition"
                        [questionsList]="competition.questions || []"
                        [editable]="false"
                        (questionSelectEmitter)="selectQuestion($event)"
                        [(questionSelected)]="questionSelected"
                        [questionsProgress]="questionsProgress"
                    ></questions-list>

                    <label
                        for="toggle-layout"
                        class="hsection pointer toggle-layout-label"
                        matTooltip="Toggle the editor layout"
                        [ngClass]="{ 'active': hrlayout }"
                    >
                        <fa-icon [icon]="layoutIcon"></fa-icon>
                    </label>

                    <input
                        id="toggle-layout"
                        type="checkbox"
                        name="hrlayout"
                        hidden
                        (change)="toggleLayout()"
                    />
                </div>

                <div id="question_title">
                    Correct Submission:
                    <b>{{ questionSelectedInfo.points }} </b> points
                    <br />
                    <span *ngIf="!questionSelectedInfo.neg_points">
                        No negative marking
                    </span>
                    <span *ngIf="questionSelectedInfo.neg_points">
                        Each incorrect submission:
                        <b>-{{ questionSelectedInfo.neg_points }} </b> points
                    </span>

                    <br /><br />
                    {{ questionSelectedInfo.title }}
                </div>

                <div id="question_statement">
                    <ng-katex
                        [data]="questionSelectedInfo.statement || ''"
                    ></ng-katex>
                </div>
            </div>

            <!-- Code editor -->
            <code-editor class="ace-editor" [(code)]="codeWritten">
            </code-editor>
        </div>

        <!-- <app-info-card>Execution services are down at the moment, the remote code execution system is being re-organized and will be back once ready to ship.</app-info-card> -->
        <div
            id="submit_controls"
            *ngIf="questionSelected != -1 && isAuthenticated"
            class="row"
        >
            <div
                matTooltip="Only submit when you're ready, to avoid negative marking"
                class="button"
                id="submit_code_btn"
                (click)="postSolution()"
            >
                Submit
            </div>
            <div
                class="button"
                id="submit_code_samples_btn"
                (click)="postSolution(true)"
                [matTooltip]="'Test samples (Shift + Alt + J)'"
            >
                Test Sample Cases
            </div>
            <div
                class="button"
                id="fetch_last_submit"
                (click)="fetchLastSubmission()"
            >
                Fetch Last Submission
            </div>
            <div>{{ fetchSubmissionMsg }}</div>
        </div>
    </div>

    <br />

    <div class="bottom-section" [ngClass]="{ 'full': bottomSection }">
        <div
            class="section-toggle"
            (click)="bottomSection = !bottomSection"
            matTooltip="Toggle the judge panel"
        >
            <fa-icon [icon]="upIcon"></fa-icon>
        </div>
        <!-- <div *ngIf="isAuthenticated && !hasEnded" class="row sa">
            <div id="pts_desc_label">Evaluation</div>
            <div id="output_label">Submission Output</div>
        </div> -->

        <h2>Question Evaluation</h2>

        <div *ngIf="isAuthenticated && !hasEnded" id="output_points">
            <div id="pts_desc" class="btable">
                <div class="table_heading">
                    <div>Submission</div>
                    <div>Points (+/-)</div>

                    <div class="points-time-col">Time</div>
                </div>
                <div *ngFor="let row of evaluation">
                    <div>
                        <a
                            class="view-submission"
                            (click)="viewSubmission(row)"
                        >
                            <fa-icon [icon]="codeIcon" [size]="'sm'"></fa-icon>
                            &nbsp; <span>View Code</span></a
                        >
                    </div>
                    <div>{{ row.result }}</div>
                    <div class="points-time-col">
                        {{
                            row.created_at | date : "yyyy MMM dd 'at' hh:mm aa"
                        }}
                    </div>
                </div>

                <div *ngIf="evaluation.length === 0">
                    <div>-</div>
                    <div>-</div>
                    <div class="points-time-col">-</div>
                </div>

                <br />

                <p>
                    You have submitted
                    {{ acceptedEvaluation + rejectedEvaluation }} solutions for
                    this question
                </p>
                <greenred
                    *ngIf="evaluation.length !== 0"
                    [green_number]="acceptedEvaluation"
                    [red_number]="rejectedEvaluation"
                    green_label="Submissions Accepted"
                    red_label="Submissions Not Accepted"
                ></greenred>

                <div
                    [ngClass]="{
                        'evaluation-next-prev': true
                    }"
                >
                    <div
                        [ngClass]="{
                            'no-click disabled':
                                loading || evaluationAfterPages.length === 0,
                            'evaluation-prev': true
                        }"
                        (click)="prevEvaluations()"
                    >
                        View Newer
                    </div>
                    <div
                        [ngClass]="{
                            'no-click disabled':
                                loading || evaluation.length < 10,
                            'evaluation-next': true
                        }"
                        (click)="nextEvaluations()"
                    >
                        View Older
                    </div>
                </div>
            </div>

            <div id="solution_output">
                <div class="loading" *ngIf="judgeInProgress">
                    <fa-icon
                        [icon]="judgeLoadingIcon"
                        [spin]="true"
                        [pulse]="true"
                    ></fa-icon>
                    &nbsp;&nbsp; Judging... this may take a few seconds
                </div>
                <div *ngIf="solutionOutput.output">
                    <h3>Output<br /></h3>
                    <pre [innerText]="solutionOutput.output"></pre>
                </div>

                <div *ngIf="solutionOutput.expected">
                    <h3>Expected<br /></h3>
                    <pre [innerText]="solutionOutput.expected"></pre>
                </div>

                <pretty-meta
                    [meta]="solutionOutput.meta"
                    [success]="solutionOutput.success"
                ></pretty-meta>
            </div>
        </div>

        <br />
        <h2 *ngIf="competition.questions">Your Overall Progress</h2>

        <div *ngIf="competition.questions" class="progress-container">
            <div class="progress-box">
                <span class="progress-num">
                    {{ questionsProgress.length }} of
                    {{ competition.questions.length }}
                </span>
                Questions Attempted
                <greenred
                    [green_number]="questionsProgress.length"
                    [red_number]="
                        (competition.questions.length || 1) -
                        questionsProgress.length
                    "
                    green_label="Attempted"
                    red_label="Unattempted"
                ></greenred>
            </div>

            <div class="progress-box">
                <span class="progress-num">
                    {{ getAcceptedSolutions() }} of
                    {{ questionsProgress.length }}
                </span>
                Questions Accepted
                <greenred
                    [green_number]="getAcceptedSolutions()"
                    [red_number]="
                        questionsProgress.length - getAcceptedSolutions()
                    "
                    green_label="Accepted"
                    red_label="Not Accepted"
                ></greenred>
            </div>

            <div class="progress-box score-box">
                You aggregated a total of &nbsp;
                <span class="progress-num">
                    {{ getTotalScore() }}
                </span>
                points
            </div>
        </div>

        <scoreboard [competition_id]="c_id"></scoreboard>
    </div>
</div>
